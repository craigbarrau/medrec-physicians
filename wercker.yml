box: node:4.2.6-slim
dev:
  steps:
    - npm-install
    - internal/watch:
        code: node app.js
        reload: true

# Build definition
build:
  # The steps that will be executed on build
  steps:
    - script:
        code: export NODE_ENV='testing'
    - npm-install
    - npm-test
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"
    - script:
        name: deploy to oracle container cloud
        code: |
          APP_FRIENDLY_NAME=MedRec-Physicians
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          POSTDATA=$(cat <<ENDOFTEMPLATE
          {
            "deployment_id": "medrec-physicians-${TIMESTAMP}",
            "deployment_name": "${APP_FRIENDLY_NAME}",
            "desired_state": 1,
            "placement": {
              "pool_id": "default"
            },
            "quantities": {
              "app": ${SCALE_AMOUNT}
            },
            "stack": {
              "content": "version: 2\nservices:\n  app:\n    image: craigbarrau/medrec-physicians\n    ports:\n      - '8080:10010/tcp'\n    environment:\n      - 'occs:availability=per-pool'\n      - 'occs:scheduler=random'",
              "service_id": "app",
              "service_name": "${APP_FRIENDLY_NAME}",
              "subtype": "service"
            }
          }
          ENDOFTEMPLATE
          )
          echo $POSTDATA
          env
          curl -k -X POST -H "Authorization: Bearer ${API_TOKEN}" -d "${POSTDATA}" ${SERVICE_MANAGER}/api/v2/deployments/

push:
  steps:
    - internal/docker-push:
        username: $DOCKERHUB_USERNAME
        password: $DOCKERHUB_PASSWORD
        repository: craigbarrau/medrec-physicians:wercker-$WERCKER_GIT_COMMIT
